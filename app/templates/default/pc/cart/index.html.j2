{% extends '/default/pc/layout/cart_base.html.j2' %}

{% block head %}
<title>{{_('我的购物车 - 一店')}}</title>
<link rel="stylesheet" href="/static/default/pc/css/cart.css">
<link rel="stylesheet" href="/static/default/pc/iconfont/iconfont.css">
{% endblock %}

{% block nav %}
<div class="one-nav_header">
  <span class="nav-header_type">{{_('我的购物车')}}</span>
</div>
{% endblock %}

{% block body %}
<div class="cart-wrap">
  <div class="head-inner">
    {% if carts %}
      <div class="cart-goods" id="cart-goods">
        <div class="bg-white">
          <div class="cart-head clearfix">
            <div class="col cart-check">
              {% set checked = 'icon-checkbox_selected' if cart_valid_total == items_quantity else '' %}
              <i id="all" class="icon-dagou icon-checkbox {{ checked }}"></i>
              <span style="margin-left:15px">{{_('全选')}}</span>
            </div>
            <div class="col cart-goods_img">&nbsp;</div>
            <div class="col cart-goods_name">商品名称</div>
            <div class="col cart-goods_price">单价</div>
            <div class="col cart-goods_num">数量</div>
            <div class="col cart-goods_total">小计</div>
            <div class="col cart-goods_action">操作</div>
          </div>
          <ul class="cart-goods_list">
            {% for cart in carts %}
              <li id="li{{cart.cart.cart_id}}" class="cart-goods_item">
                <div class="col cart-check">
                  {% set checked = 'icon-checkbox_selected' if cart.cart.is_checked == 1 else '' %}
                  {% set checked = checked if cart.is_valid == 1 else 'icon-notsel' %}
                  {% set is_valid = 'is_valid' if cart.is_valid == 1 else '' %}
                  <i class="icon-dagou icon-checkbox {{ checked }} {{ is_valid }}" id="cart{{cart.cart.cart_id}}" data-cart-id="{{ cart.cart.cart_id }}" data-quantity="{{ cart.cart.quantity }}" data-is-valid="{{ cart.is_valid }}"></i>
                </div>
                <div class="col cart-goods_img">
                  <img src="{{ cart.item.goods_img }}" alt="">
                </div>
                {% set goods_class = 'cart-valid' if cart.is_valid == 1 else 'cart-goods_name' %}
                <div class="col {{ goods_class }}">
                  <a href="{{ url_for('pc.item.detail', goods_id=cart.item.goods_id) }}">
                    <p class="all-text">{{ cart.item.goods_name }}</p>
                    <p class="greyGap">
                    {% if cart.is_valid == 0 %}
                      {% set status = _('已下架') if cart.valid_status == 1 else _('库存不足') %}
                      <span class="cart-status">{{status}}</span>
                    {% endif %}
                    </p>
                  </a>
                </div>
                <div class="col cart-goods_price">
                  <span class="all-text">￥{{ cart.item.goods_price }}</span>
                </div>
                <div class="col cart-goods_num">
                  <div class="apply-service_num">
                    <i class="num_minus" onclick="update_cart_quantity({{ cart.cart.cart_id }}, 0)"></i>
                    <input class="num_ipt change_cart_quantity" type="text" id="quantity{{cart.cart.cart_id}}" name="quantity{{cart.cart.cart_id}}" value="{{ cart.cart.quantity }}" data-cart-id="{{cart.cart.cart_id}}" data-value="{{ cart.cart.quantity }}" minnum="1">
                    <i class="num_add" onclick="update_cart_quantity({{ cart.cart.cart_id }}, 1)"></i>
                  </div>
                </div>
                <div class="col cart-goods_total">
                  <span id="items_amount{{ cart.cart.cart_id }}" class="all-text" style="color:#f33155 !important">￥{{ cart.items_amount }}</span>
                </div>
                <div class="col cart-goods_action">
                  <a class="del" href="javascript:void(0);" onclick="remove({{cart.cart.cart_id}})">
                    <i class="icon-cancel"></i>
                  </a>
                </div>
              </li>
            {% endfor %}
          </ul>
        </div>
        <div class="cart-footer clearfix">
          <div class="cart-footer_left">
            <a class="back-shopping" href="{{ url_for('pc.index.root') }}">{{_('继续购物')}}</a>
            <span class="cart-total_num">
              {{_('共')}}
              <i id="cart_total">{{ cart_total }}</i>
              {{_('件商品，已选择')}}
              <i id="items_quantity">{{ items_quantity }}</i>
              {{_('件')}}
            </span>
          </div>
          <div class="cart-footer_right">
            <span class="cart-total_price">
              {{_('合计：')}}￥
              <em id="items_amount">{{ items_amount }}</em>
            </span>
            <a class="cart-checkout_btn btn-primary" href="javascript:void(0);" onclick="checkout()">{{_('去结算')}}</a>
          </div>
        </div>
      </div>
    {% else %}
      <div class="not-one">
        <p class="not-one_text">{{_('您的购物车空空如也!')}}</p>
        <a class="not-one_btn btn-primary" href="{{ url_for('pc.index.root') }}">{{_('到商场去看看')}}</a>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block script %}
<script type="text/javascript">
function get_carts() {
  var carts = [];

  $(".is_valid").each(function(){
    var cart = {};
    cart.cart_id = $(this).attr('data-cart-id');
    cart.is_checked = $(this).hasClass('icon-checkbox_selected') ? 1 : 0;

    carts.push(cart);
  });

  return JSON.stringify(carts);
}


function checked(carts) {
  $.get("{{ url_for('api.cart.checked') }}", {'carts':carts}, function(json) {
    if (json.ret != 0) {
      $.toast(json.msg, "text");
      return false;
    }

    $("#cart_total").text(json.data.cart_total);
    $("#items_quantity").text(json.data.items_quantity);
    $("#items_amount").text(json.data.items_amount);
  });
}


function update_cart(cart_id, quantity) {
  var ret = true;
  $.get("{{ url_for('api.cart.update') }}", {'cart_id':cart_id, 'quantity':quantity}, function(json) {
    if (json.ret == 0) {
      $("#cart_total").text(json.data.cart_total);
      $("#items_quantity").text(json.data.items_quantity);
      $("#items_amount").text(json.data.items_amount);
      $("#items_amount"+cart_id).text("￥"+json.data._items_amount);

      ret = false;
    } else {
      // 优化alert ??
      alert(json.msg);
      ret = true;
    }
  });

  return ret;
}


function update_cart_quantity(cart_id, is_add) {
  var quantity = parseInt($("#quantity"+cart_id).val());

  if (is_add) {
    quantity += 1;
  } else {
    quantity -= 1;
    quantity = quantity > 1 ? quantity : 1;
  }

  var ret = update_cart(cart_id, quantity);
  if (ret) {
    $("#quantity"+cart_id).val(quantity);
    $("#quantity"+cart_id).attr('data-value', quantity);
  }
}


function remove(cart_id) {
  // 优化confirm
  var r = confirm("{{_('确认删除？')}}");
  if (r==true) {
    $.get("{{ url_for('api.cart.remove') }}", {'carts_id':cart_id}, function(json) {
      if (json.ret == 0) {
        $("#cart_total").text(json.data.cart_total);
        $("#items_quantity").text(json.data.items_quantity);
        $("#items_amount").text(json.data.items_amount);
        $("#li"+cart_id).remove();
      } else {
        // 优化alert ??
        alert(json.msg);
      }
    });
  }
}


function checkout() {
  var carts_id = [];

  $(".is_valid").each(function(){
    if ($(this).hasClass('icon-checkbox_selected')) {
      var cart_id = parseInt($(this).attr('data-cart-id'));
      carts_id.push(cart_id);
    }
  });

  if (carts_id.length == 0) {
    // 优化alert ??
    alert("{{_('请选择结算商品')}}");
    return false;
  }

  var carts_id_json = JSON.stringify(carts_id);
  window.location.href="{{ url_for('pc.cart.checkout') }}?carts_id="+carts_id_json;
}


$(function(){
  $(".change_cart_quantity").focusout(function(){
    var quantity = parseInt($(this).val());
    var cart_id = parseInt($(this).attr('data-cart-id'));

    if (isNaN(quantity) || quantity <= 0) {
      $(this).val($(this).attr('data-value'));
      return false;
    }

    var ret = update_cart(cart_id, quantity);
    if (ret) {
      $(this).attr('data-value', quantity);
    }
  });


  $("#all").click(function(){
    if ($(this).hasClass('icon-checkbox_selected')) {
      $(".is_valid").removeClass('icon-checkbox_selected');
      $(this).removeClass('icon-checkbox_selected');
    } else {
      $(".is_valid").addClass('icon-checkbox_selected');
      $(this).addClass('icon-checkbox_selected');
    }

    var carts = get_carts();
    checked(carts);
  });


  $(".is_valid").click(function(){
    var is_all = 1;

    if ($(this).hasClass('icon-checkbox_selected')) {
      $(this).removeClass('icon-checkbox_selected');
    } else {
      $(this).addClass('icon-checkbox_selected');
    }
  
    $(".is_valid").each(function(){
      if (!$(this).hasClass('icon-checkbox_selected')) {
        is_all = 0;
      }
    });

    (is_all == 1) ? $("#all").addClass('icon-checkbox_selected') : $("#all").removeClass('icon-checkbox_selected');

    var carts = get_carts();
    checked(carts);
  });
});
</script>
{% endblock%}