{% extends '/default/mobile/layout/base.html.j2' %}
{% import '/default/mobile/libs/libs.html.j2' as libs %}

{% block head %}
<title>{{_('我的购物车 - 一店')}}</title>
<link rel="stylesheet" href="{{'/static/default/mobile/css/cart.css'|static_uri}}"> 
{% endblock %} 

{% block body %}
<div class="cart_wrap">
  <div class="content_wrap">
    {% for cart in carts %}
      <div class="weui-cells weui-cells_checkbox flex_wrap">
        <label class="weui-check__label" for="cart{{cart.cart.cart_id}}">
          <div class="col-check">
            {% set checked = 'checked' if cart.cart.is_checked == 1 else '' %}
            {% set checked = checked if cart.is_valid == 1 else '' %}
            {% set is_valid = 'is_valid' if cart.is_valid == 1 else '' %}
            <input type="checkbox" class="weui-check {{ is_valid }}" name="checkbox1" 
              id="cart{{cart.cart.cart_id}}" value="{{ cart.cart.cart_id }}" {{ checked }}  
              data-cart-id="{{ cart.cart.cart_id }}" data-quantity="{{ cart.cart.quantity }}" 
              data-is-valid="{{ cart.is_valid }}">
            <i class="weui-icon-checked icon-checked"></i>
          </div>
        </label>
        <a class="weui-cell" style="overflow:hidden;width:100%" href="{{ url_for('mobile.cart.edit', cart_id=cart.cart.cart_id) }}">
          <div class="weui-cell__hd cart_phone">
            <img alt="" src="">
          </div>
          {% if cart.is_valid == 1 %}
            <div class="weui-cell__bd">
              <div class="all_title mar-bottom">{{ cart.item.goods_name }}</div>
              <div class="cart_count">
                <span>x {{ cart.cart.quantity }}</span>
              </div>
            </div>
            <div class="weui-cell__ft mar-left width46">
              <span class="all_price">￥{{ cart.item.goods_price }}</span>
            </div>
          {% else %}
            <div class="weui-cell__bd">
              <div class="invalid_title mar-bottom">{{ cart.item.goods_name }}</div>
              <div class="cart_count">
                {% set status = _('已下架') if cart.valid_status == 1 else _('库存不足') %}
                <span class="mar-left">{{ status }}</span>
              </div>
            </div>
            <div class="weui-cell__ft mar-left width46">
              <span class="invalid_price">￥{{ cart.item.goods_price }}</span>
            </div>
          {% endif %}
        </a>
      </div>
    {% endfor %}
    <div class="settlement_wrap">
      <div class="weui-cells weui-cells_checkbox cart_bar">
        <label class="weui-check__label" for="s1">
          <div class="col-check">
            {% set checked = 'checked' if total_quantity == items_quantity else '' %}
            <input type="checkbox" class="weui-check" name="checkbox1" id="s1" {{ checked }}>
            <i class="weui-icon-checked" style="margin-left:10px !important"></i>
            <p class="all_check">全选</p>
          </div>
        </label>
        <div class="total">
          <div class="total-price">
            <span>合计：</span>
            <span class="all_price" style="font-size:18px">￥{{ items_amount }}</span>
          </div>
          <a href="{{ url_for('mobile.cart.checkout') }}" class="btn_primary">{{_('结算(%s)' % items_quantity)}}</a>
        </div>
      </div>
    </div>
  </div>
  <!-- 购物车没有商品时显示 -->
  <!-- <div class="not-product">
    <div class="not-product_img">
      <img class="notproduct" src="/static/default/mobile/img/notcart.png" alt="">
    </div>
    <div class="not-product_text">{{_('您的购物车空空如也')}}</div>
    <div class="reg_btn">
      <a href="{{ url_for('mobile.index.root') }}">
        <button type="button" class="weui-btn weui-btn_red">{{_('到商城去逛逛')}}</button>
      </a>
    </div>
  </div> -->

  {{ libs.bottom_navigation_bar() }}
</div>
{% endblock %} 

{% block script %}
<script  type="text/javascript">
$(document).ready(function () {
  function get_carts() {
    var carts = [];

    $(".is_valid").each(function(){
      var cart = {};
      cart.cart_id = $(this).val();
      cart.is_checked = $(this).is(':checked') ? 1 : 0;

      carts.push(cart);
    });
    console.log(carts);

    return JSON.stringify(carts);
  }

  function checked(carts) {
    console.log(carts);
    $.get("{{ url_for('api.cart.checked') }}", {'carts':carts}, function(json) {
      if (json.ret != 0) {
        $.toast(json.msg, "text");
        return false;
      }

      console.log(json.data.items_amount);
      console.log(json.data.items_quantity);
      return true;
    });
  }

  //$("#all").click(function(){
  $("#s1").click(function(){
    if ($(this).is(':checked')) {
      $(".is_valid").prop('checked', true);
    } else {
      $(".is_valid").prop('checked', false);
    }

    var carts = get_carts();
    checked(carts);
  });

  $(".is_valid").click(function(){
    var is_all = 1;
  
    $(".is_valid").each(function(){
      if (!$(this).is(':checked')) {
        is_all = 0;
      }
    });

    (is_all == 1) ? $("#s1").prop('checked', true) : $("#s1").prop('checked', false);
  });
});
</script>
{% endblock %}