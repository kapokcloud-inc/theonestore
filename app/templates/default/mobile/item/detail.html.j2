{% extends '/default/mobile/layout/base.html.j2' %}
{% import '/default/mobile/libs/const.html.j2' as const %}

{% block head %}
<title>{{_('商品详情 - 一店')}}</title>
<link rel="stylesheet" href="/static/default/mobile/css/item.css">
<link rel="stylesheet" href="/static/default/mobile/css/index.css">
<link rel="stylesheet" href="/static/default/mobile/css/cart.css">
{% endblock %} 

{% block body %}
<div class="detail-top">
  <div class="detail-top_title">
    <a class="detail-top_item on" href="#nav1" id="nav11">
      <span>{{_('商品')}}</span>
    </a>
    <a class="detail-top_item" href="#nav2" id="nav22">
      <span>{{_('评价')}}</span>
    </a>
    <a class="detail-top_item" href="#nav3" id="nav33">
      <span>{{_('详情')}}</span>
    </a>
  </div>
</div>
<div class="index_wrap">
  <div id="nav1">
    <div class="category_wrap">
      <div class="swiper-container" data-space-between='10' data-pagination='.swiper-pagination' data-autoplay="1000">
        <div class="swiper-wrapper">
          {% for gallery in galleries %}
            <div class="swiper-slide">
              <img class="swiper-img" src="{{ gallery.img }}" alt="">
            </div>
          {% endfor %}
        </div>
      </div>
      <div class="swiper-pagination"></div>
    </div>
    <div class="detail_title">
      <div class="all_title">{{ item.goods_name }}</div>
      <div class="all_desc">{{ item.goods_desc }}</div>
      <div class="all_price">
        <span>￥{{ item.goods_price }}</span>
        {% if item.market_price > 0 %}
        <span class="price_del">￥{{ item.market_price }}</span>
        {% endif %}
      </div>
    </div>
    <div class="weui-cells">
      <a class="weui-cell weui-cell_access" href="javascript:;" onclick="choice()">
        <div class="weui-cell__hd">
          <label class="weui-label greykGap">{{_('规格')}}</label>
        </div>
        <div class="weui-cell__bd">
          <span class="blackGap">{{ item.goods_name }}</span>
          <span id="goods_quantity_text" class="mar-left">x 1</span>
        </div>
        <div class="weui-cell__ft"></div>
      </a>
      <div class="hide ranpo" id="specifications">
        <div class="hide-mask"></div>
        <div class="weui-actionsheet weui-actionsheet_toggle">
          <div class="weui-actionsheet__menu bg-white">
            <input type="hidden" name="" id="" value="">
            <div class="weui-actionsheet__cell not-product_text">
              <span>{{_('选择购买数量')}}</span>
            </div>
            <div class="weui-cell">
              <div class="weui-cell__hd height50">
                <div class="cart_phone">
                  <img alt="" src="">
                </div>
              </div>
              <div class="weui-cell__bd">
                <p class="all_title">{{ item.goods_name }}</p>
              </div>
              <div class="weui-cell__ft mar-left width46">
                <span class="all_price">￥{{ item.goods_price }}</span>
              </div>
            </div>
            <div class="weui-cell">
              <div class="weui-cell__bd blackGap">{{_('购买数量')}}</div>
              <div class="weui-cell__ft mar-left">
                <div class="apply-service_num">
                  <i class="num_minus"></i>
                  <input class="num_ipt" type="text" id="goods_quantity" name="goods_quantity" value="1" minnum="1">
                  <i class="num_add"></i>
                </div>
              </div>
            </div>
            <div class="reg_btn">
              <button type="button" class="weui-btn weui-btn_red" onClick="determine()">{{_('确定')}}</button>
            </div>
          </div>
        </div>
      </div>
      <div class="weui-cell">
        <ul class="detail_serve weui-cell__bd">
          <li class="detail_serve_item">
            <img class="tagImg" src="/static/default/mobile/img/like.png" alt="">
            <span class="tagText">{{_('7天无理由退货')}}</span>
          </li>
          <li class="detail_serve_item">
            <img class="tagImg" src="/static/default/mobile/img/like.png" alt="">
            <span class="tagText">{{_('运费险')}}</span>
          </li>
          <li class="detail_serve_item">
            <img class="tagImg" src="/static/default/mobile/img/like.png" alt="">
            <span class="tagText">{{_('48小时内发货')}}</span>
          </li>
        </ul>
        <div class="weui-cell__ft mar-left" onclick="tips()">
          <img class="tipsImg" src="/static/default/mobile/img/tips.png" alt="">
        </div>
        <div class="hide ranpo" id="explain">
          <div class="hide-mask"></div>
          <div class="weui-actionsheet weui-actionsheet_toggle">
            <div class="weui-actionsheet__menu bg-white">
              <input type="hidden" name="" id="" value="">
              <div class="weui-actionsheet__cell not-product_text">
                <span>{{_('服务说明')}}</span>
              </div>
              <div class="weui-cell">
                <div class="weui-cell__bd">
                  <p class="blackGap">{{_('7天无理由退货')}}</p>
                  <p class="greykGap mar-top">{{_('此商品支持7天无理由退货，换货')}}</p>
                </div>
              </div>
              <div class="weui-cell">
                <div class="weui-cell__bd">
                  <p class="blackGap">{{_('运费险')}}</p>
                  <p class="greykGap  mar-top">{{_('购买此商品赠送运费险')}}</p>
                </div>
              </div>
              <div class="weui-cell">
                <div class="weui-cell__bd">
                  <p class="blackGap">{{_('48小时内发货')}}</p>
                  <p class="greykGap mar-top">{{_('商家承诺下单成功48小时内发货')}}</p>
                </div>
              </div>
              <div class="reg_btn">
                <button type="button" class="weui-btn weui-btn_red" onClick="know()">{{_('知道了')}}</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% if item.comment_count > 0 %}
    <div id="nav2">
      <div class="weui-cells">
        <a class="weui-cell weui-cell_access" href="{{ url_for('mobile.comment.index', ttype=1, tid=item.goods_id, rating=3) }}">
          <div class="weui-cell__bd">
            <span class="blackGap">{{_('评价')}}</span>
            <span class="mar-left praise_rate">{{_('好评%s' % item.comment_good_rate)}}%</span>
          </div>
          <div class="weui-cell__ft">
            <span>{{_('共计%s条' % item.comment_count)}}</span>
          </div>
        </a>
        {% for comment in comments %}
          <div class="weui-media-box weui-media-box_appmsg">
            <div class="weui-media-box__hd">
              <img class="weui-media-box__thumb ava" src="{{ comment.avatar }}" alt="">
            </div>
            <div class="weui-media-box__bd">
              <div class="all_title">
                {{ comment.nickname }}
                <span class="typeText">{{ const.RATING_TEXT.get(comment.rating) }}</span>
              </div>
              <div class="all_add" style="margin-top:5px">{{ comment.add_time|timestamp2str }}</div>
              <div class="review_cnt">{{ comment.content }}</div>
              <div class="mar-top">
                {% set imgs = comment.img_data|json_loads %}
                {% for img in imgs %}
                  <span class="review_img">
                    <img src="{{ img }}" alt="">
                  </span>
                {% endfor %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  {% endif %}
  <div id="nav3">
    <div class="weui-cells">
      <div class="pro-detail_tit">{{_('商品详情')}}</div>
      {{ item.detail }}
    </div>
  </div>
  <div class="height61"></div>
  <div class="footer">
    {% set uid = session.get('uid', 0) %}
    {% set action = 'login()' if uid == 0 else 'fav(this)' %}
    {% set src = '/static/default/mobile/img/like.png' if is_fav == 1 else '/static/default/mobile/img/notlike.png' %}
    <div class="icon_wrap" style="border-right:1px solid #e5e5e5" data-tid="{{ item.goods_id }}" onclick="{{ action }}">
      <img src="{{ src }}" alt="">
    </div>
    <div class="icon_wrap" onclick="toCart()">
      {% set cart_total = session.get('cart_total', 0) %}
      <span id="cart_total" class="weui-badge msg_badge">{{ cart_total }}</span>
      <img src="/static/default/mobile/img/cart.png" alt="">
    </div>

    {% if item.is_sale != 1 %}
      <div style="flex:6">
        <button type="button" class="downOut">{{_('商品已下架')}}</button>
      </div>
    {% elif item.stock_quantity <= 0 %}
      <div style="flex:3">
        <button type="button" class="buyTo">{{_('缺货')}}</button>
      </div>
    {% else %}
      <div style="flex:3" onclick="cartTo({{ item.goods_id }})">
        <button type="button" class="cartTo">{{_('加入购物车')}}</button>
      </div>
      <a href="{{ url_for('mobile.cart.checkout', buy_now=1, goods_id=item.goods_id) }}" style="flex:3">
        <button type="button" class="buyTo">{{_('立即购买')}}</button>
      </a>
    {% endif %}

  </div>
</div>
{% endblock %} 

{% block script %}
<script type="text/javascript" src="https://cdn.bootcss.com/jquery-weui/1.2.0/js/swiper.min.js" charset="utf-8"></script>
<script type="text/javascript">
  $(function () {
    $(window).scroll(function () {
      //为页面添加页面滚动监听事件
      var wst = $(window).scrollTop()+46 //滚动条距离顶端值
      for (i = 1; i < 4; i++) {             //加循环
        if ($("#nav" + i).offset().top <= wst) { //判断滚动条位置
          $('.detail-top_item').removeClass("on"); //清除c类
          $("#nav" + i + i).addClass("on");	//给当前导航加c类
        }
      }
    })

    $(".detail-top_item").click(function () {
      $(this).addClass('on').siblings().removeClass('on');
    });
  });

  //轮播图
  $(".swiper-container").swiper({
    loop: true,
    //autoplay: 3000,
  });

  //计数器
  var MIN = 1;
  
  $('.num_minus').click(function (e) {
    var $input = $(e.currentTarget).parent().find('#goods_quantity');
    var number = parseInt($input.val() || "0") - 1;
  
    if (number < MIN) number = MIN;
    $input.val(number);
  })

  $('.num_add').click(function (e) {
    var $input = $(e.currentTarget).parent().find('#goods_quantity');
    var number = parseInt($input.val() || "0") + 1;

    $input.val(number);
  })

  var $explain = $('#explain');
  var $specifications = $('#specifications');

  //服务说明弹窗
  function tips() {
    // 显示弹窗
    if ($explain.hasClass('hide')) {
      $explain.removeClass('hide').addClass('show');
    }
  }

  //服务说明弹窗
  function know() {
    // 关闭弹窗
    if ($explain.hasClass('show')) {
      $explain.removeClass('show').addClass('hide');
    }
  }

  //选择商品规格弹窗
  function choice() {
    // 显示弹窗
    if ($specifications.hasClass('hide')) {
      $specifications.removeClass('hide').addClass('show');
    }
  }

  //选择商品规格弹窗
  function determine() {
    var number = parseInt($("#goods_quantity").val());

    if (number <= 0) {
      $.toast("{{_('购买数量不能小于0')}}", "text");
      return false;
    }

    $("#goods_quantity_text").text('x ' + number);

    // 关闭弹窗
    if ($specifications.hasClass('show')) {
      $specifications.removeClass('show').addClass('hide');
    }
  }

  //加入购物车
  function cartTo(goods_id) {
    var quantity = parseInt($("#goods_quantity").val());

    if (quantity <= 0) {
      $.toast("{{_('购买数量不能小于0')}}", "text");
      return false;
    }

    $.get("{{ url_for('api.cart.add') }}", {'goods_id':goods_id, 'quantity':quantity}, function(json) {
      if (json.ret != 0) {
        $.toast(res.msg, "text");
        return false;
      }

      $("#cart_total").text(json.data.cart_total);
      $.toast("{{_('已加入购物车')}}", "text");
    });
  }

  //去购物车
  function toCart() {
    window.location.href = "{{ url_for('mobile.cart.root') }}";
  }

  //收藏
  function fav(dom) {
    var $dom = $(dom);
    var tid = $dom.attr('data-tid');
    var params = {'like_type':2, 'ttype':1, 'tid':tid}

    $.get("{{ url_for('api.like.action') }}", params, function(json) {
      if (json.ret != 0) {
        $.toast(json.msg, "text");
        return false;
      }

      if (json.data.action_code == 1) {
        $dom.children().first().attr('src', '/static/default/mobile/img/like.png');
      } else {
        $dom.children().first().attr('src', '/static/default/mobile/img/notlike.png');
      }
    });
  }

  //跳转登录
  function login() {
    window.location.href = "{{ url_for('api.weixin.login') }}";
  }
</script> 
{% endblock %}